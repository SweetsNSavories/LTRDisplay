name: Build PCF Solution

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.json'
      - '**/*.pcfproj'
      - '**/*.xml'
      - 'package-lock.json'
      - 'package.json'
      - '.github/workflows/build-pcf-solution.yml'

jobs:
  build-solution:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: LTRDisplayControl/package-lock.json

      - name: Configure NuGet feeds
        shell: pwsh
        run: |
          $xml = @'
<configuration>
  <packageSources>
    <add key="nuget.org" value="https://api.nuget.org/v3/index.json" />
    <add key="PowerAppsTools" value="https://pkgs.dev.azure.com/dynamicscrm/PowerAppsTools/_packaging/PowerAppsTools/nuget/v3/index.json" />
  </packageSources>
</configuration>
'@
          Set-Content NuGet.config -Value $xml

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install Power Platform CLI
        shell: pwsh
        run: |
          dotnet tool install --global Microsoft.PowerApps.CLI.Tool
          $toolPath = "$env:USERPROFILE/.dotnet/tools"
          # Ensure pac is available now and for subsequent steps
          $env:PATH = "$toolPath;" + $env:PATH
          Add-Content -Path $env:GITHUB_PATH -Value $toolPath
          pac help

      - name: Install npm dependencies
        working-directory: LTRDisplayControl
        run: npm ci

      - name: Build PCF control
        working-directory: LTRDisplayControl
        run: npm run build

      - name: Initialize solution wrapper
        shell: pwsh
        run: |
          if (-not (Test-Path Solution)) {
            pac solution init --publisher-name LTR_Publisher --publisher-prefix com --outputDirectory Solution
          }

      - name: Add PCF project reference
        shell: pwsh
        working-directory: Solution
        run: |
          pac solution add-reference --path ..\LTRDisplayControl\LTRDisplayControl.pcfproj

      - name: Build solution ZIPs
        shell: pwsh
        working-directory: Solution
        run: |
          dotnet build .\Solution.cdsproj -c Release

      - name: Upload solution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pcf-solution-zips
          path: Solution/bin/Release/*.zip
